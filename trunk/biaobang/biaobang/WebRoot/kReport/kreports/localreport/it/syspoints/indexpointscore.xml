<?xml version="1.0" encoding="GB2312"?> 
<kreport>
	<name>indexpointscore</name>
	<display-name>指标得分</display-name>
	<page-size></page-size>
	<condition-size>4</condition-size>
	<skin></skin>	
	<actions>
		<action name="query">
			<index>10</index>
			<display-name>查询</display-name>
			<do>doQuery()</do>
		</action>
		<action name="export">
			<index>20</index>
			<display-name>导出</display-name>
			<do>doExport()</do>
		</action>
		<action name="reset">
			<index>100</index>
			<display-name>重置</display-name>
			<do>doReset()</do>
		</action>
	</actions>	
	<conditions>
		<condition name="month">
			<index>10</index>
			<display-name>查询月份</display-name>
			<type>select</type>
			<required>true</required>
			<return-type>string</return-type>
			<extend><![CDATA[
				select s.month,regexp_replace(s.month,'(....)(..)','\1年\2月') 
				from qry_index_point_score s
				where s.month<to_char(sysdate,'yyyymm')
				group by s.month
				order by s.month desc
			]]></extend>
		</condition>	
	</conditions>	
	<data>
			<thead>
			<![CDATA[<tr style='color:#ffffff;font-size:9pt;font-family:宋体;line-height:14pt;text-align:center;background-color:#A5C7EF;'>
				<td nowrap>系统</td>
				<td nowrap>类型</td>
				<td nowrap>指标</td>
				<td nowrap>描述</td>
				<td nowrap>权重</td>
				<td nowrap>责任科室</td>
				<td nowrap>负责人</td>
				<td nowrap>得分</td>
				<td nowrap>扣分原因</td>
				<td nowrap>发起工单</td>
			</tr>
			<script>			
				function dispatchAll(month){
					if(confirm("确定对所有扣分项发起工单吗？\n(批量发单需要一定时间，请耐心等待)")){
						var queryForm = document.getElementById("_query");
						queryForm.action="/report/BloccheckpointWorkOrderAction!createFlows.do";
						queryForm.submit();
					}
				}
				function dispatch(id,value){
					if(value=='满分'){
						alert("没有扣分，不能发起扣分工单");
					}else if(value=="派单>>"){
						window.location.href="/report/BloccheckpointWorkOrderAction!createFlow.do?scoreId="+id;
					}else{
						openWindow('/viewFlow.do?serialNO='+value);
					}
				}
			</script>
			]]>
		</thead>
		<tbody>
			<![CDATA[<tr style='font-size:9pt;font-family:宋体;line-height:14pt;	background-color:white;'>
				<td nowrap align="center">${1}</td>
				<td nowrap align="center">${2}</td>
				<td>${3}</td>
				<td>${4}</td>
				<td nowrap>${5}</td>
				<td>${6}</td>
				<td>${7}</td>
				<td nowrap align="center">${8}</td>
				<td>${9}</td>
				<td nowrap><a href="javascript:dispatch('${11}','${10}')">${10}</a></td>				
			</tr>]]>
		</tbody>
		<tfoot>
			<![CDATA[
			<tr style='font-size:9pt;font-family:宋体;line-height:14pt;	background-color:white;'>
				<td colspan="11" align="center">
					<input type="button" value="批量发起工单" onclick="dispatchAll()"/>
				</td>
			</tr>
			]]>
		</tfoot>
		<export>${1},${2},${3},${4},${5},${6},${7},${8},${9},${10}</export>
	</data>
	<ksql><![CDATA[
		select p.system 系统,
		       p.type 类型,
		       p.name 指标,
		       p.description 描述,
		       s.point 权重,
		       s.dept 责任科室,
		       s.handler 负责人,
		       s.score 得分,
		       s.reason 扣分原因,
		       decode(s.score,s.point,'满分',nvl(f.serialno,'派单>>')) 派单,
		       s.id
		from qry_index_point p,qry_index_point_score s,rec_flow f
		where p.id=s.index_point_id
		  and s.flowlsh=f.flowlsh(+)
		  #[and s.month=${month}] 
		order by p.system_order,p.type_order,p.index_order
		]]>
	</ksql>
</kreport>