<?xml version="1.0" encoding="GB2312"?> 
<kreport>
	<name>indexpointscore_edit</name>
	<display-name>指标得分</display-name>
	<page-size></page-size>
	<condition-size>4</condition-size>
	<skin></skin>	
	<actions>
		<action name="query">
			<index>10</index>
			<display-name>查询</display-name>
			<do>doQuery()</do>
		</action>
		<action name="export">
			<index>20</index>
			<display-name>导出</display-name>
			<do>doExport()</do>
		</action>
		<action name="reset">
			<index>100</index>
			<display-name>重置</display-name>
			<do>doReset()</do>
		</action>
	</actions>	
	<conditions>
		<condition name="month">
			<index>10</index>
			<display-name>查询月份</display-name>
			<type>select</type>
			<required>true</required>
			<return-type>string</return-type>
			<extend><![CDATA[
				select s.month,regexp_replace(s.month,'(....)(..)','\1年\2月') 
				from qry_index_point_score s
				where s.month<to_char(sysdate,'yyyymm')
				group by s.month
				order by s.month desc
			]]></extend>
		</condition>	
	</conditions>	
	<data>
			<thead>
			<![CDATA[<tr style='color:#ffffff;font-size:9pt;font-family:宋体;line-height:14pt;text-align:center;background-color:#A5C7EF;'>
				<td nowrap>系统</td>
				<td nowrap>类型</td>
				<td nowrap>指标</td>
				<td nowrap>描述</td>
				<td nowrap>权重</td>
				<td nowrap>责任科室</td>
				<td nowrap>负责人</td>
				<td nowrap>得分</td>
				<td nowrap>扣分原因</td>
				<td nowrap>发起工单</td>
			</tr>
			<script>
				function dispatch(id,value){
					if(value=='满分'){
						alert("没有扣分，不能发起扣分工单");
					}else if(value=="派单>>"){
						window.location.href="/report/BloccheckpointWorkOrderAction!createFlow.do?scoreId="+id;
					}else{
						openWindow('/viewFlow.do?serialNO='+value);
					}
				}
				function checkNum(Obj, min, max) {
					var thisnum = Obj.value;
					if (thisnum == "")
						return true;					
					if (isNaN(thisnum) != true)// 当输入为数值
					{
						if(thisnum<min || thisnum>max){
							alert("请输入一个"+min+"与"+max+"之间的数值");
							Obj.focus();
						}
					}else{
						alert("请输入一个"+min+"与"+max+"之间的数值");
						Obj.focus();
					}
				}
				
				function changremark(){
					var remarks = document.getElementsByTagName("textarea");
					for(var i=0;i<remarks.length;i++){
						if(remarks[i].value!=""){
						    remarks[i].value=encodeURI(remarks[i].value);
						}
					}
				}
				
				function save(){
					var editForm = document.getElementById("edit");
					edit.submit();
				}
			</script>

			<form id="edit" name="edit" method='post' action="/report/BloccheckpointWorkOrderAction!edit.do" onsubmit="changremark()">
			]]>
		</thead>
		<tbody>
			<![CDATA[<tr style='font-size:9pt;font-family:宋体;line-height:14pt;	background-color:white;'>
				<td nowrap align="center">${1}</td>
				<td nowrap align="center">${2}</td>
				<td>${3}</td>
				<td>${4}</td>
				<td nowrap>${5}</td>
				<td>${6}</td>
				<td>${7}</td>				
				<td nowrap align="center"><input type="text" name="score_${11}" value="${8}" onblur="checkNum(this,${12},${13})" style="width:40px"/></td>
				<td align="center"><textarea name="reason_${11}"  cols="20" rows="2">${9}</textarea></td>				
				<td nowrap><a href="javascript:dispatch('${11}','${10}')">${10}</a></td>				
			</tr>]]>
		</tbody>
		<tfoot>
			<![CDATA[
			<tr style='font-size:9pt;font-family:宋体;line-height:14pt;	background-color:white;'>
				<td colspan="11" align="center">
					<input type="submit" value="保存" />
				</td>
			</tr>
			</form>
			]]>
		</tfoot>
	</data>
	<ksql><![CDATA[
		select p.system 系统,
		       p.type 类型,
		       p.name 指标,
		       p.description 描述,
		       s.point 权重,
		       s.dept 责任科室,
		       s.handler 负责人,
		       s.score 得分,
		       s.reason 扣分原因,
		       nvl(f.serialno,'') 派单,
		       s.id,
		       s.min,
		       s.max
		from qry_index_point p,qry_index_point_score s,rec_flow f
		where p.id=s.index_point_id
		  and s.flowlsh=f.flowlsh(+)
		  #[and s.month=${month}] 
		order by p.system_order,p.type_order,p.index_order
		]]>
	</ksql>
</kreport>